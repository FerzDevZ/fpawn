#!/bin/bash

# fpawn Master - The Ultimate Pawn Application
# Created for: FerzDevZ
# Version: 16.1 (Fine-tuned Intelligence)
# Engines: qawno (open.mp) & pawno (Legacy SAMP)
# Repo: https://github.com/FerzDevZ/fpawn

# --- DIRECTORIES ---
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" 
done
BASE_DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"

QAWNO_DIR="$BASE_DIR/qawno"
PAWNO_DIR="$BASE_DIR/pawno"
GLOBAL_INC="$BASE_DIR/bin/includes"
CONFIG_FILE="$HOME/.ferzdevz/fpawn/config"

# Colors (Electric Nebula Palette)
GREEN='\033[38;5;82m'
BLUE='\033[38;5;39m'
RED='\033[38;5;196m'
YELLOW='\033[38;5;226m'
CYAN='\033[38;5;51m'
MAGENTA='\033[38;5;201m'
ORANGE='\033[38;5;208m'
BOLD='\033[1m'
NC='\033[0m'

# --- CONFIGURATION ---

function load_config() {
    REPO_OWNER="FerzDevZ"
    REPO_NAME="fpawn"
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
    else
        mkdir -p "$(dirname "$CONFIG_FILE")"
        echo "REPO_OWNER=\"FerzDevZ\"" > "$CONFIG_FILE"
        echo "REPO_NAME=\"fpawn\"" >> "$CONFIG_FILE"
    fi
}

# --- HELPERS ---

function find_entry_point() {
    # 1. Check Root
    [ -f "main.pwn" ] && { echo "main.pwn"; return; }
    # 2. Check src/
    [ -f "src/main.pwn" ] && { echo "src/main.pwn"; return; }
    # 3. Check gamemodes/
    [ -f "gamemodes/main.pwn" ] && { echo "gamemodes/main.pwn"; return; }
    # 4. Search any .pwn
    local ANY=$(find . -maxdepth 2 -name "*.pwn" | head -n 1 | sed 's|^./||')
    if [ -n "$ANY" ]; then echo "$ANY"; return; fi
    echo ""
}

# --- MASTER INTELLIGENCE ---

function project_scanner() {
    echo -e "${BLUE}[Autopilot]${NC} Initiating Neural Project Scan..."
    local MAIN_FILE=$(find_entry_point)
    
    if [ -z "$MAIN_FILE" ]; then
        echo -e "${RED}[Error]${NC} No .pwn entry point detected recursively."
        return 1
    fi

    echo -e "${CYAN}[Scan]${NC} Component: ${BOLD}$MAIN_FILE${NC}"
    
    local INCS=$(grep "#include" "$MAIN_FILE" | sed 's/.*<//;s/>.*//;s/.*"//;s/".*//' | sort -u)
    local MISSING=()
    local SEARCH_PATHS=("include" "pawno/include" "dependencies" "$GLOBAL_INC")
    
    for INC in $INCS; do
        [[ "$INC" =~ ^(a_samp|open.mp|core|float|string|file|time|datagram|console|a_mysql|streamer|sscanf2)$ ]] && continue
        local FOUND=false
        for PD in "${SEARCH_PATHS[@]}"; do [ -f "$PD/$INC.inc" ] && { FOUND=true; break; }; done
        [ "$FOUND" = false ] && MISSING+=("$INC")
    done

    if [ ${#MISSING[@]} -eq 0 ]; then
        echo -e "${GREEN}[Verified]${NC} Ecosystem integrity 100%. No missing includes."
    else
        echo -e "${ORANGE}[Warning]${NC} Detected ${#MISSING[@]} missing dependencies:"
        for M in "${MISSING[@]}"; do echo -e " ❌ ${M}.inc"; done
        echo -e ""
        read -p "Would you like fpawn to search and fix these? [y/N] " ANS
        if [[ "$ANS" == "y" ]]; then
            for M in "${MISSING[@]}"; do
                echo -e "${BLUE}[Fixer]${NC} Searching for $M..."
                smart_finder "$M.inc" || dynamic_search "$M"
            done
        fi
    fi
}

function static_analyst() {
     local FILE=$(find_entry_point)
     [ -z "$FILE" ] && { echo -e "${RED}[Error]${NC} Entry point missing."; return 1; }
     
     echo -e "${BLUE}[Analyst]${NC} Inspecting ${CYAN}$FILE${NC} architecture..."
     grep -q "main()" "$FILE" || echo -e " [!] ${YELLOW}Notice:${NC} Entry point 'main()' missing."
     
     local LINES=$(wc -l < "$FILE")
     echo -e " [+] ${GREEN}Volume:${NC} $LINES lines detected."
     
     [ -f "pawn.json" ] && echo -e " [i] ${CYAN}Logic:${NC} Modern open.mp architecture detected."
     [ -f "server.cfg" ] && echo -e " [i] ${YELLOW}Logic:${NC} Legacy SA-MP architecture detected."
     
     echo -e "${GREEN}[Status]${NC} Analysis complete."
}

# --- SEARCH & CLONER ---

function repo_cloner() {
    local URL=$1; local NAME=$2
    echo -e "${BLUE}[Cloner]${NC} Cloning ${CYAN}$NAME${NC}..."
    git clone --depth 1 "$URL" "$NAME"
    [ $? -eq 0 ] && echo -e "${GREEN}[Success]${NC} Cloned to ./${NAME}" || echo -e "${RED}[Error]${NC} Clone failed."
}

function dynamic_search() {
    local QUERY=$1
    echo -e "${BLUE}[Search]${NC} Navigating Galaxy for '${CYAN}$QUERY${NC}'..."
    
    echo -e "${YELLOW}[Neural Link]${NC} Querying GitHub Hub..."
    local SEARCH_URL="https://api.github.com/search/repositories?q=${QUERY}+pawn+language:Pawn&sort=stars"
    local JSON=$(curl -s "$SEARCH_URL")
    
    local RESULTS=""
    if command -v jq &> /dev/null; then
        RESULTS=$(echo "$JSON" | jq -r '.items[] | select(.html_url != null) | "\(.full_name)|\(.html_url)|\(.description)"' | head -n 5)
    fi

    if [ -n "$RESULTS" ]; then
        local i=1; local URLS=(); local NAMES=()
        IFS=$'\n'
        for RES in $RESULTS; do
            local FNAME=$(echo "$RES" | cut -d'|' -f1); local FURL=$(echo "$RES" | cut -d'|' -f2); local FDESC=$(echo "$RES" | cut -d'|' -f3)
            URLS+=( "$FURL" ); NAMES+=( "${FNAME#*/}" )
            echo -e " [$i] ${BOLD}${CYAN}$FNAME${NC}"
            [ -n "$FDESC" ] && [[ "$FDESC" != "null" ]] && echo -e "     ${MAGENTA}Note:${NC} $FDESC"
            echo -e "     ${BLUE}Repo:${NC} $FURL"
            ((i++))
        done
        unset IFS
        
        echo -e ""
        read -p "Execute Clone index? [1-5 or Enter to skip]: " PICK
        if [[ "$PICK" =~ ^[1-5]$ ]]; then
            local IDX=$((PICK-1))
            repo_cloner "${URLS[$IDX]}" "${NAMES[$IDX]}"
        fi
    else
        echo -e "${RED}[Notice]${NC} Global repositories for '$QUERY' are dark."
    fi
}

# --- TUI V3 MASTER-UI ---

function show_header() {
    clear
    echo -e " ${BLUE}┌──────────────────────────────────────────────────────────┐${NC}"
    echo -e " ${BLUE}│${NC}${BOLD}${CYAN}      fpawn v16.1 - FerzDevZ Fine-tuned Intelligence      ${NC}${BLUE}│${NC}"
    echo -e " ${BLUE}└──────────────────────────────────────────────────────────┘${NC}"
    local CTX="${RED}NO CONTEXT${NC}"
    [ -f "pawn.json" ] && CTX="${GREEN}OPEN.MP ECOSYSTEM${NC}"
    [ -f "server.cfg" ] && CTX="${YELLOW}LEGACY SA-MP${NC}"
    echo -e "  Project Status: $CTX"
    echo ""
}

function show_dashboard() {
    show_header
    echo -e "  ${BOLD}ENGINEERING${NC}                    ${BOLD}INTELLIGENCE${NC}"
    echo -e "  [1] Compile Script             [4] ${YELLOW}Actionable Search${NC}"
    echo -e "  [2] Start Master Server        [5] ${CYAN}Analyze Architecture${NC}"
    echo -e "  [3] Live Matrix Monitor        [6] ${GREEN}Project Autopilot (Scan)${NC}"
    echo -e ""
    echo -e "  ${BOLD}MASTERY TOOLS${NC}                  ${BOLD}SYSTEM${NC}"
    echo -e "  [7] Optimize Release Build     [10] Library Refresh"
    echo -e "  [8] Benchmark Core Stability   [11] Self Cloud Update"
    echo -e "  [9] Full Server Forge          [0] Exit Application"
    echo ""
    echo -e " ${BLUE}────────────────────────────────────────────────────────────${NC}"
    read -p " Selection Master: " CHOICE
    case $CHOICE in
        1) local F=$(find_entry_point); [ -z "$F" ] && F="main.pwn"; execute_compiler "auto" "auto" "$F"; exit ;;
        2) server_runner; exit ;;
        3) local F=$(find_entry_point); [ -z "$F" ] && F="main.pwn"; run_watch_mode "$F"; exit ;;
        4) read -p " Keywords: " S; dynamic_search "$S"; read -p "Press Enter..."; show_dashboard ;;
        5) static_analyst; read -p "Press Enter..."; show_dashboard ;;
        6) project_scanner; read -p "Press Enter..."; show_dashboard ;;
        7) optimizer_engine; exit ;;
        9) read -p " (1)Legacy (2)OMP: " T; [ "$T" == "1" ] && install_server_binaries "legacy"; [ "$T" == "2" ] && install_server_binaries "omp"; exit ;;
        10) library_updater; read -p "Press Enter..."; show_dashboard ;;
        11) self_update; exit ;;
        0) exit 0 ;;
        *) show_dashboard ;;
    esac
}

# --- CORE FUNCTIONS ---

function execute_compiler() {
    local ENG=$1; local PROF=$2; shift 2; 
    local FILE="${!#}"; local ARGS=(); [ $# -gt 1 ] && ARGS=("${@:1:$#-1}")
    [[ "$FILE" != *.pwn ]] && { echo -e "${RED}[Error]${NC} Entry point missing."; return 1; }
    local OUT="/tmp/fpawn_out.log"; local INC_FLAGS=()
    [ "$PROF" = "omp" ] && { [ -d "include" ] && INC_FLAGS+=("-iinclude"); [ -d "dependencies" ] && INC_FLAGS+=("-idependencies"); }
    [ "$PROF" = "legacy" ] && { [ -d "pawno/include" ] && INC_FLAGS+=("-ipawno/include"); [ -d "include" ] && INC_FLAGS+=("-iinclude"); }
    INC_FLAGS+=("-i$GLOBAL_INC")
    
    if [ "$ENG" = "qawno" ] || { [ "$ENG" = "auto" ] && [ "$PROF" = "omp" ]; }; then
        chmod +x "$QAWNO_DIR/pawncc"; export LD_LIBRARY_PATH="$QAWNO_DIR:$LD_LIBRARY_PATH"
        "$QAWNO_DIR/pawncc" "$FILE" "${ARGS[@]}" "${INC_FLAGS[@]}" "-i$QAWNO_DIR/include" "-;+" > "$OUT" 2>&1
    else
        wine "$PAWNO_DIR/pawncc.exe" "$FILE" "${ARGS[@]}" "${INC_FLAGS[@]}" "-i$PAWNO_DIR/include" > "$OUT" 2>&1
    fi
    local STAT=$?
    if grep -q "fatal error 100" "$OUT"; then
        local MIS=$(grep "fatal error 100" "$OUT" | head -n 1 | sed 's/.*: "\(.*\)".*/\1/')
        if [ $RETRY_COUNT -lt 5 ] && smart_finder "$MIS.inc"; then ((RETRY_COUNT++)); execute_compiler "$ENG" "$PROF" "$@"; return $?; fi
    fi
    cat "$OUT" | sed -u -e "s/error \([0-9]\{3\}\)/\x1b[1;31merror \1\x1b[0m/g" -e "s/warning \([0-9]\{3\}\)/\x1b[1;33mwarning \1\x1b[0m/g"
    return $STAT
}

function optimizer_engine() {
    local T=$(find_entry_point); [ -z "$T" ] && T="main.pwn"
    echo -e "${BLUE}[Master]${NC} Release optimization for $T..."
    execute_compiler "auto" "auto" "-O2" "$T"
}

function self_update() {
    local R="https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/fpawn"
    curl -L -s -o /tmp/fupd "$R"
    if [ $? -eq 0 ]; then
        local NV=$(grep "Version:" /tmp/fupd | head -n 1 | awk '{print $3}')
        if [ "$NV" != "16.1" ] && [ -n "$NV" ]; then
             echo -e "${YELLOW}[Alert]${NC} Master v$NV available. Elevating..."; cp /tmp/fupd "$BASE_DIR/fpawn"; chmod +x "$BASE_DIR/fpawn"; exit 0
        else echo -e "${GREEN}[Success]${NC} Mastery is up-to-date."; fi
    fi
}

function install_server_binaries() {
    local TYPE=$1; echo -e "${MAGENTA}[Forge]${NC} Hammering binaries for ${CYAN}$TYPE${NC}..."
    if [ "$TYPE" = "omp" ]; then
        curl -L -f -o omp.tar.gz "https://github.com/openmultiplayer/open.mp/releases/download/v1.1.0.2612/open.mp-linux-x86.tar.gz"
        tar -xzf omp.tar.gz; [ -d "Server" ] && { mv Server/* ./; rmdir Server; }; [ -f "omp-server" ] && chmod +x omp-server
    else
        curl -L -f -o samp.tar.gz "https://sa-mp.co.id/files/samp037svr_R2-1.tar.gz"; tar -xzf samp.tar.gz; [ -d "samp03" ] && { mv samp03/* ./; rmdir samp03; }; chmod +x samp03svr
    fi
}

function smart_finder() {
    local INC=$1; local RESP=$(curl -s "https://api.github.com/search/code?q=filename:$INC+extension:inc")
    local URL=$(echo "$RESP" | grep -o "\"html_url\": \"[^\"]*\"" | head -n 1 | sed 's/"html_url": //;s/"//g;s/github.com/raw.githubusercontent.com/;s/\/blob\//\//')
    if [ -n "$URL" ]; then 
        local TD="include"; [ -d "pawno/include" ] && TD="pawno/include"; mkdir -p "$TD"; curl -L -s -o "$TD/$INC" "$URL" && return 0
    fi; return 1
}

function library_updater() {
    local TD="include"; [ -d "pawno/include" ] && TD="pawno/include"; mkdir -p "$TD"
    curl -L -s -o "$TD/a_samp.inc" "https://raw.githubusercontent.com/pawn-lang/samp-stdlib/master/a_samp.inc"
    echo -e "${GREEN}[Done]${NC} Core refreshed."
}

function server_runner() {
    local B=""; [ -f "./omp-server" ] && B="./omp-server"; [ -f "./samp03svr" ] && B="./samp03svr"
    export LD_LIBRARY_PATH=".:$LD_LIBRARY_PATH"
    [ -n "$B" ] && "$B" 2>&1 | sed -u -e "s/error.*/${RED}&${NC}/i" -e "s/info.*/${GREEN}&${NC}/i"
}

# --- BOOT ---
load_config
RETRY_COUNT=0
if [ $# -eq 0 ]; then show_dashboard; exit 0; fi

while [[ $# -gt 0 ]]; do
    case $1 in
        --search) dynamic_search "$2"; exit 0 ;;
        --scan) project_scanner; exit 0 ;;
        --analyze) static_analyst; exit 0 ;;
        --update-self) self_update; exit 0 ;;
        --plugin) plugin_manager "$2"; exit 0 ;;
        *.pwn) PASSED_ARGS+=( "$1" ); shift ;;
        *) shift ;;
    esac
done
execute_compiler "auto" "auto" "${PASSED_ARGS[@]}"
