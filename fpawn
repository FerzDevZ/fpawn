#!/bin/bash

# fpawn Master - The Ultimate Pawn Application
# Created for: FerzDevZ
# Version: 15.2 (Actionable Search & Cloner)
# Engines: qawno (open.mp) & pawno (Legacy SAMP)
# Repo: https://github.com/FerzDevZ/fpawn

# --- DIRECTORIES ---
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" 
done
BASE_DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"

QAWNO_DIR="$BASE_DIR/qawno"
PAWNO_DIR="$BASE_DIR/pawno"
GLOBAL_INC="$BASE_DIR/bin/includes"
CONFIG_FILE="$HOME/.ferzdevz/fpawn/config"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m'

# --- CONFIGURATION ---

function load_config() {
    REPO_OWNER="FerzDevZ"
    REPO_NAME="fpawn"
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
    else
        mkdir -p "$(dirname "$CONFIG_FILE")"
        echo "REPO_OWNER=\"FerzDevZ\"" > "$CONFIG_FILE"
        echo "REPO_NAME=\"fpawn\"" >> "$CONFIG_FILE"
    fi
}

# --- SEARCH & CLONER ---

function repo_cloner() {
    local URL=$1
    local NAME=$2
    echo -e "${BLUE}[Cloner]${NC} Cloning ${CYAN}$NAME${NC} into project..."
    git clone --depth 1 "$URL" "$NAME"
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}[Success]${NC} Repository cloned to ${BOLD}./$NAME${NC}"
    else
        echo -e "${RED}[Error]${NC} Failed to clone repository."
    fi
}

function dynamic_search() {
    local QUERY=$1
    echo -e "${BLUE}[Search]${NC} Identifying '${CYAN}$QUERY${NC}' in ecosystems..."
    
    # Massive Internal list
    local PLUGINS=("streamer" "mysql" "sscanf" "crashdetect" "nativechecker" "mapfix" "pawn-raknet" "colandreas" "fcnpc" "samp-voice" "discord-connector" "pawn-regex" "whirlpool" "bcrypt" "totp" "skyline" "dns" "socket" "pawn-plus" "pawn-scheduler" "pawn-memory" "pawn-uuid" "cmd-plus" "y_td" "y_va" "y_iterate" "y_hooks" "mbt" "nex-ac" "scand")
    
    local FOUND_LOCAL=()
    for PLG in "${PLUGINS[@]}"; do
        if [[ "$PLG" == *"$QUERY"* ]]; then
            FOUND_LOCAL+=("$PLG")
        fi
    done
    
    if [ ${#FOUND_LOCAL[@]} -gt 0 ]; then
        echo -e "${GREEN}[Local Results]${NC}"
        for PLG in "${FOUND_LOCAL[@]}"; do
            echo -e " - ${BOLD}$PLG${NC} (Use: fpawn --plugin $PLG)"
        done
        echo ""
    fi

    echo -e "${YELLOW}[Ultra Search]${NC} Querying GitHub API..."
    local SEARCH_URL="https://api.github.com/search/repositories?q=${QUERY}+pawn+in:name,description&sort=stars"
    local RESP=$(curl -s "$SEARCH_URL")
    
    # Enhanced Parsing with names and descriptions
    # We use a temp file to store results for the interactive picker
    local TEMP_RESULTS="/tmp/fpawn_search_results"
    echo "$RESP" | grep -o "\"full_name\": \"[^\"]*\", \"html_url\": \"[^\"]*\", \"description\": \"[^\"]*\"" | head -n 5 > "$TEMP_RESULTS"
    # Fallback if no full info
    if [ ! -s "$TEMP_RESULTS" ]; then
         echo "$RESP" | grep -o "\"html_url\": \"[^\"]*\"" | head -n 5 | sed 's/"html_url": //' | sed 's/"//g' > "$TEMP_RESULTS"
    fi

    local REPO_URLS=()
    local REPO_NAMES=()
    local i=1

    if [ -s "$TEMP_RESULTS" ]; then
        echo -e "${CYAN}[GitHub Results]${NC}"
        while read -r LINE; do
            local URL=$(echo "$LINE" | grep -o "https://github.com/[^\"]*" | head -n 1)
            local FULL_NAME=$(echo "$LINE" | grep -o "\"full_name\": \"[^\"]*\"" | sed 's/"full_name": //' | sed 's/"//g')
            local DESC=$(echo "$LINE" | grep -o "\"description\": \"[^\"]*\"" | sed 's/"description": //' | sed 's/"//g')
            
            [ -z "$URL" ] && URL="$LINE"
            [ -z "$FULL_NAME" ] && FULL_NAME=$(basename "$URL")
            
            REPO_URLS+=("$URL")
            REPO_NAMES+=("$FULL_NAME")
            
            echo -e " [$i] ${BOLD}$FULL_NAME${NC}"
            [ -n "$DESC" ] && echo -e "     ${MAGENTA}Desc:${NC} $DESC"
            echo -e "     ${CYAN}URL:${NC} $URL"
            ((i++))
        done < "$TEMP_RESULTS"
        
        echo -e ""
        read -p "Select # to Clone (or press Enter to skip): " PICK
        if [[ "$PICK" =~ ^[1-5]$ ]]; then
            local IDX=$((PICK-1))
            repo_cloner "${REPO_URLS[$IDX]}" "${REPO_NAMES[$IDX]##*/}"
        fi
    else
        echo -e "${RED}[Failed]${NC} No GitHub matches for '$QUERY'."
    fi
    rm -f "$TEMP_RESULTS"
}

# --- CONNECTED ECORE ---

function self_update() {
    local SILENT=$1
    [ "$SILENT" != "true" ] && echo -e "${BLUE}[Cloud]${NC} Checking for updates at ${CYAN}${REPO_OWNER}/${REPO_NAME}${NC}..."
    local REMOTE_FILE="https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/fpawn"
    local TEMP_FILE="/tmp/fpawn_new"
    curl -L -s -o "$TEMP_FILE" "$REMOTE_FILE"
    if [ $? -eq 0 ]; then
        local NEW_VER=$(grep "Version:" "$TEMP_FILE" | head -n 1 | awk '{print $3}')
        local CUR_VER="15.2"
        if [ "$NEW_VER" != "$CUR_VER" ] && [ -n "$NEW_VER" ]; then
            if [ "$SILENT" == "true" ]; then
                echo -e "${MAGENTA}[Notice]${NC} Ver ${BOLD}$NEW_VER${NC} is out! Menu [11] to update."
                return 0
            fi
            echo -e "${YELLOW}[Update]${NC} New: ${BOLD}$NEW_VER${NC} (Current: $CUR_VER)"
            read -p "Update? [y/N] " CHOICE
            if [[ "$CHOICE" == "y" ]]; then
                cp "$TEMP_FILE" "$BASE_DIR/fpawn"; chmod +x "$BASE_DIR/fpawn"
                echo -e "${GREEN}[Success]${NC} Updated to $NEW_VER."; rm "$TEMP_FILE"; exit 0
            fi
        elif [ "$SILENT" != "true" ]; then
            echo -e "${GREEN}[Success]${NC} Up to date ($CUR_VER)."
        fi
    fi
    rm -f "$TEMP_FILE"
}

# --- CI/CD & UPDATER ---

function generate_ci_workflow() {
    echo -e "${BLUE}[CI]${NC} Generating GitHub Actions..."
    mkdir -p .github/workflows
    cat > .github/workflows/build.yml <<EOF
name: Build and Test
on: [push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Pawn
        uses: openmultiplayer/setup-pawn@v1
        with:
          version: '3.10.10'
      - name: Compile
        run: pawncc main.pwn -iinclude -d3
EOF
    echo -e "${GREEN}[Success]${NC} Generated .github/workflows/build.yml"
}

function library_updater() {
    echo -e "${BLUE}[Update]${NC} Core Libraries..."
    local TINC="include"; [ -d "pawno/include" ] && TINC="pawno/include"
    mkdir -p "$TINC"
    curl -L -s -o "$TINC/a_samp.inc" "https://raw.githubusercontent.com/pawn-lang/samp-stdlib/master/a_samp.inc"
    if [ -f "pawn.json" ]; then
        curl -L -s -o "$TINC/open.mp.inc" "https://raw.githubusercontent.com/openmultiplayer/open.mp-stdlib/master/open.mp.inc"
    fi
    echo -e "${GREEN}[Success]${NC} Done."
}

# --- PLUGIN DATABASE ---

function install_plugin_logic() {
    local NAME=$1; local CONTEXT=$2
    local TINC="include"; [ -d "pawno/include" ] && TINC="pawno/include"
    mkdir -p "$TINC" plugins
    [ "$CONTEXT" = "omp" ] && case $NAME in crashdetect|nativechecker|mapfix|skyline) echo -e "${YELLOW}[Warning]${NC} Built-in in open.mp."; return 0 ;; esac
    echo -e "${BLUE}[FPM]${NC} Installing ${CYAN}${NAME}${NC}..."
    case $NAME in
        streamer) curl -L -s -o "$TINC/streamer.inc" "https://raw.githubusercontent.com/samp-incognito/samp-streamer-plugin/master/include/streamer.inc"; curl -L -s -o "plugins/streamer.so" "https://github.com/samp-incognito/samp-streamer-plugin/releases/download/v2.9.6/streamer.so" ;;
        mysql)    curl -L -s -o "$TINC/a_mysql.inc" "https://raw.githubusercontent.com/pBlueG/SA-MP-MySQL/master/a_mysql.inc"; curl -L -s -o "plugins/mysql.so" "https://github.com/pBlueG/SA-MP-MySQL/releases/download/R41-4/mysql.so" ;;
        sscanf)   curl -L -s -o "$TINC/sscanf2.inc" "https://raw.githubusercontent.com/Y-Less/sscanf/master/sscanf2.inc"; curl -L -s -o "plugins/sscanf.so" "https://github.com/Y-Less/sscanf/releases/download/v2.11.4/sscanf.so" ;;
        # (Other 20+ plugins remain compatible via smart-finder fallback)
        *) if smart_finder "${NAME}.inc"; then return 0; fi; echo -e "${RED}[Error]${NC} Plugin $NAME not found."; return 1 ;;
    esac
    [ -f "server.cfg" ] && { local P="$NAME.so"; [ "$NAME" == "pawn-raknet" ] && P="Pawn.RakNet.so"; grep -q "$P" server.cfg || sed -i "s/^plugins /& $P /" server.cfg 2>/dev/null || echo "plugins $P" >> server.cfg; }
    echo -e "${GREEN}[Success]${NC} Done."
}

# --- ENGINE ---

function execute_compiler() {
    local ENG=$1; local PROF=$2; shift 2; 
    local FILE="${!#}"; local ARGS=(); [ $# -gt 1 ] && ARGS=("${@:1:$#-1}")
    [[ "$FILE" != *.pwn ]] && { echo -e "${RED}[Error]${NC} Last arg must be .pwn"; return 1; }
    local OUT="/tmp/fpawn_out.log"; local INC_FLAGS=()
    [ "$PROF" = "omp" ] && { [ -d "include" ] && INC_FLAGS+=("-iinclude"); [ -d "dependencies" ] && INC_FLAGS+=("-idependencies"); }
    [ "$PROF" = "legacy" ] && { [ -d "pawno/include" ] && INC_FLAGS+=("-ipawno/include"); [ -d "include" ] && INC_FLAGS+=("-iinclude"); }
    INC_FLAGS+=("-i$GLOBAL_INC")
    if [ "$ENG" = "qawno" ]; then
        chmod +x "$QAWNO_DIR/pawncc"; export LD_LIBRARY_PATH="$QAWNO_DIR:$LD_LIBRARY_PATH"
        "$QAWNO_DIR/pawncc" "$FILE" "${ARGS[@]}" "${INC_FLAGS[@]}" "-i$QAWNO_DIR/include" "-;+" > "$OUT" 2>&1
    else
        wine "$PAWNO_DIR/pawncc.exe" "$FILE" "${ARGS[@]}" "${INC_FLAGS[@]}" "-i$PAWNO_DIR/include" > "$OUT" 2>&1
    fi
    local STAT=$?
    if grep -q "fatal error 100" "$OUT"; then
        local MIS=$(grep "fatal error 100" "$OUT" | head -n 1 | sed 's/.*: "\(.*\)".*/\1/')
        if [ $RETRY_COUNT -lt 5 ] && smart_finder "$MIS.inc"; then ((RETRY_COUNT++)); execute_compiler "$ENG" "$PROF" "$@"; return $?; fi
    fi
    cat "$OUT" | sed -u -e "s/error \([0-9]\{3\}\)/\x1b[1;31merror \1\x1b[0m/g" -e "s/warning \([0-9]\{3\}\)/\x1b[1;33mwarning \1\x1b[0m/g"
    return $STAT
}

function show_dashboard() {
    clear
    echo -e "${BLUE}======================================================${NC}"
    echo -e "${BOLD}          fpawn v15.2 - FerzDevZ Mastery Suite${NC}"
    echo -e "${BLUE}======================================================${NC}"
    local CTX="Unknown"; [ -f "pawn.json" ] && CTX="${GREEN}open.mp${NC}"; [ -f "server.cfg" ] && CTX="${YELLOW}SA-MP Legacy${NC}"
    echo -e "Context: $CTX"
    echo -e ""
    echo -e " [1] Compile Script       [2] Start Server"
    echo -e " [3] Live Monitor         [4] ${YELLOW}Actionable Search${NC}"
    echo -e " [5] Optimize Build       [6] Benchmark Server"
    echo -e " [7] Cloud Backup         [8] CI/CD Workflow"
    echo -e " [9] Update Libraries     [10] Full Server Init"
    echo -e " [11] Self Update        [0] Exit"
    echo -e ""
    read -p "Select: " CHOICE
    case $CHOICE in
        1) read -p "File: " F; [ -z "$F" ] && F="main.pwn"; execute_compiler "auto" "auto" "$F"; exit ;;
        2) server_runner; exit ;;
        3) read -p "File: " F; [ -z "$F" ] && F="main.pwn"; TARGET_FILE="$F"; run_watch_mode; exit ;;
        4) read -p "Search: " S; dynamic_search "$S"; read -p "Press Enter..."; show_dashboard ;;
        5) optimizer_engine "$2"; exit ;;
        6) benchmark_mode; exit ;;
        10) read -p "1=Legacy 2=OMP: " T; [ "$T" == "1" ] && install_server_binaries "legacy"; [ "$T" == "2" ] && install_server_binaries "omp"; exit ;;
        11) self_update; exit ;;
        0) exit 0 ;;
        *) show_dashboard ;;
    esac
}

# --- START ---
load_config
RETRY_COUNT=0
if [ $# -eq 0 ]; then self_update "true"; show_dashboard; exit 0; fi

while [[ $# -gt 0 ]]; do
    case $1 in
        --search) dynamic_search "$2"; exit 0 ;;
        --update-self) self_update; exit 0 ;;
        --plugin) plugin_manager "$2"; shift 2; exit 0 ;;
        *.pwn) TARGET_FILE=$1; PASSED_ARGS+=("$1"); shift ;;
        *) PASSED_ARGS+=("$1"); shift ;;
    esac
done
execute_compiler "auto" "auto" "${PASSED_ARGS[@]}"
