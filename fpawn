#!/bin/bash

# fpawn Master - The Ultimate Pawn Application
# Created for: FerzDevZ
# Version: 17.0 (Architect & Evolution Edition)
# Engines: qawno (open.mp) & pawno (Legacy SAMP)
# Repo: https://github.com/FerzDevZ/fpawn

# --- DIRECTORIES ---
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" 
done
BASE_DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"

QAWNO_DIR="$BASE_DIR/qawno"
PAWNO_DIR="$BASE_DIR/pawno"
GLOBAL_INC="$BASE_DIR/bin/includes"
CONFIG_FILE="$HOME/.ferzdevz/fpawn/config"
CACHE_DIR="$HOME/.ferzdevz/fpawn/cache/includes"

# Colors (Architect Sapphire Palette)
GREEN='\033[38;5;82m'
BLUE='\033[38;5;39m'
RED='\033[38;5;196m'
YELLOW='\033[38;5;226m'
CYAN='\033[38;5;51m'
MAGENTA='\033[38;5;201m'
ORANGE='\033[38;5;208m'
WHITE='\033[38;5;255m'
BOLD='\033[1m'
NC='\033[0m'

# --- CONFIGURATION & CACHE ---

function load_config() {
    REPO_OWNER="FerzDevZ"
    REPO_NAME="fpawn"
    mkdir -p "$(dirname "$CONFIG_FILE")" "$CACHE_DIR"
    [ ! -f "$CONFIG_FILE" ] && echo -e "REPO_OWNER=\"FerzDevZ\"\nREPO_NAME=\"fpawn\"" > "$CONFIG_FILE"
    source "$CONFIG_FILE"
}

# --- THE ARTISAN (CODE POLISHER) ---

function code_polisher() {
    local TARGET=$1
    [[ -z "$TARGET" ]] && TARGET=$(find_entry_point)
    [[ -z "$TARGET" ]] && { echo -e "${RED}[Error]${NC} No script target found."; return 1; }

    echo -e "${CYAN}[Artisan]${NC} Polishing ${BOLD}$TARGET${NC} aesthetics..."
    
    local TEMP="/tmp/polisher_tmp.pwn"
    # Basic Formatting Logic:
    # 1. Standardize Indentation (4 spaces)
    # 2. Fix spacing around Operators (=, +, -, *, /, ==, !=)
    # 3. Ensure curly braces on newline (Allman style)
    
    cat "$TARGET" | \
    sed 's/^\s*//' | \
    sed 's/\s*$//' | \
    # Add spacing around operators
    sed -E 's/([^ <>!=])=([^ =])/\1 = \2/g' | \
    # Basic indentation logic (very simple implementation for Bash)
    sed 's/{/ {\n/g' | sed 's/}/\n}\n/g' | \
    awk '
    {
        if ($0 ~ /}/) indent--;
        for (i=0; i<indent; i++) printf "    ";
        print $0;
        if ($0 ~ /{/) indent++;
    }' > "$TEMP"

    cp "$TEMP" "$TARGET"
    echo -e "${GREEN}[Success]${NC} Code is now balanced and professional."
    rm -f "$TEMP"
}

# --- THE ARCHITECT (MODULAR GM) ---

function template_architect() {
    echo -e "${BLUE}[Architect]${NC} Casting Modular Foundation..."
    local NAME="new_project"
    read -p " Project Name (Default: gm_modular): " PNAME
    [ -n "$PNAME" ] && NAME=$PNAME
    
    mkdir -p "$NAME/core" "$NAME/modules/player" "$NAME/modules/admin" "$NAME/include" "$NAME/gamemodes"
    
    cat > "$NAME/gamemodes/$NAME.pwn" <<EOF
#include <open.mp>
#include "../core/init.inc"
#include "../modules/player/setup.inc"

main() {
    print("----------------------------------");
    print(" $NAME System Online ");
    print(" Powered by FerzDevZ fpawn v17 ");
    print("----------------------------------");
}
EOF
    touch "$NAME/core/init.inc" "$NAME/modules/player/setup.inc"
    echo -e "${GREEN}[Success]${NC} Modular structure '$NAME' generated."
}

# --- NEURAL DIAGNOSE ---

function neural_diagnose() {
    local LOG="log.txt"; [ -f "server_log.txt" ] && LOG="server_log.txt"
    echo -e "${ORANGE}[Neural]${NC} Probe deep-scanning ${CYAN}$LOG${NC}..."
    
    if grep -q "Runtime error" "$LOG"; then
        echo -e "${RED}[Signature]${NC} Logic overflow detected."
        # Extract last fatal signature
        grep -A 5 "Runtime error" "$LOG" | tail -n 5
    elif grep -q "backtrace" "$LOG"; then
        echo -e "${RED}[Signature]${NC} Stack-trace detected. Mapping symbols..."
        grep -B 2 -A 10 "backtrace" "$LOG" | tail -n 12
    else
        echo -e "${GREEN}[Verified]${NC} No terminal anomalies found in biological logs."
    fi
}

# --- HELPERS & INTELLIGENCE ---

function find_entry_point() {
    [ -f "main.pwn" ] && { echo "main.pwn"; return; }
    [ -f "src/main.pwn" ] && { echo "src/main.pwn"; return; }
    [ -f "gamemodes/main.pwn" ] && { echo "gamemodes/main.pwn"; return; }
    local ANY=$(find . -maxdepth 2 -name "*.pwn" | head -n 1 | sed 's|^./||')
    echo "$ANY"
}

function project_scanner() {
    echo -e "${BLUE}[Autopilot]${NC} Scanning Neural Grids..."
    local MAIN_FILE=$(find_entry_point)
    [[ -z "$MAIN_FILE" ]] && { echo -e "${RED}[Error]${NC} No entry point found."; return 1; }

    local INCS=$(grep "#include" "$MAIN_FILE" | sed 's/.*<//;s/>.*//;s/.*"//;s/".*//' | sort -u)
    local MISSING_LIST=(); local CORRUPT_LIST=()
    local SEARCH_PATHS=("include" "pawno/include" "dependencies" "$GLOBAL_INC" "$CACHE_DIR")
    
    for INC in $INCS; do
        [[ "$INC" =~ ^(core|float|string|file|time|datagram|console)$ ]] && continue
        local FOUND=false; local CORRUPT=false
        for PD in "${SEARCH_PATHS[@]}"; do 
            if [ -f "$PD/$INC.inc" ]; then
                FOUND=true
                head -n 1 "$PD/$INC.inc" | grep -q "404:" && CORRUPT=true
                break
            fi
        done
        [ "$FOUND" = false ] && MISSING_LIST+=("$INC")
        [ "$CORRUPT" = true ] && CORRUPT_LIST+=("$INC")
    done

    if [ ${#MISSING_LIST[@]} -eq 0 ] && [ ${#CORRUPT_LIST[@]} -eq 0 ]; then
        echo -e "${GREEN}[Ready]${NC} Project architecture is healthy."
    else
        [ ${#CORRUPT_LIST[@]} -gt 0 ] && echo -e "${RED}[Warning]${NC} Corrupted components: ${CORRUPT_LIST[*]}"
        read -p "Trigger Evolution/Repair? [y/N] " ANS
        if [[ "$ANS" == "y" ]]; then
            for M in "${MISSING_LIST[@]}" "${CORRUPT_LIST[@]}"; do
                rm -f "include/$M.inc" "$CACHE_DIR/$M.inc"
                echo -e "${BLUE}[Sync]${NC} Evolutionary link for $M..."
                smart_finder "$M.inc" || dynamic_search "$M"
            done
        fi
    fi
}

# --- TUI V4 EVOLUTION ---

function show_header() {
    clear
    echo -e " ${WHITE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e " ${WHITE}â•‘${NC}${BOLD}${BLUE}      fpawn v17.0 - FerzDevZ Architect & Evolution       ${NC}${WHITE}â•‘${NC}"
    echo -e " ${WHITE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    local STATUS="${RED}DARK${NC}"
    [ -f "pawn.json" ] && STATUS="${GREEN}SYNCHRONIZED (OMP)${NC}"
    [ -f "server.cfg" ] && STATUS="${YELLOW}LEGACY (SAMP)${NC}"
    echo -e "  Ecosystem Status: $STATUS"
    echo ""
}

function show_dashboard() {
    show_header
    echo -e "  ${BOLD}ENGINEERING${NC}                    ${BOLD}EVOLUTION${NC}"
    echo -e "  [1] Compile Script             [4] ${YELLOW}Neural Search${NC}"
    echo -e "  [2] Start Instance             [5] ${CYAN}Analyze Architecture${NC}"
    echo -e "  [3] Matrix Monitor             [6] ${GREEN}Project Autopilot${NC}"
    echo ""
    echo -e "  ${BOLD}MASTER TOOLS${NC}                   ${BOLD}SYSTEM${NC}"
    echo -e "  [7] ${BOLD}${WHITE}Code Polisher (âœ¨)${NC}        [10] Library Sync"
    echo -e "  [8] ${CYAN}Architect Template (ðŸ—ï¸)${NC}     [11] Cloud Self-Update"
    echo -e "  [9] ${ORANGE}Neural Diagnose (ðŸ•µï¸)${NC}       [0]  Shutdown Suite"
    echo ""
    echo -e " ${WHITE}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    read -p " Selection Master: " CHOICE
    case $CHOICE in
        1) local F=$(find_entry_point); execute_compiler "auto" "auto" "${F:-main.pwn}"; exit ;;
        2) server_runner; exit ;;
        3) local F=$(find_entry_point); run_watch_mode "${F:-main.pwn}"; exit ;;
        4) read -p " Topic: " S; dynamic_search "$S"; read -p "Enter..."; show_dashboard ;;
        5) static_analyst; read -p "Enter..."; show_dashboard ;;
        6) project_scanner; read -p "Enter..."; show_dashboard ;;
        7) read -p " File to Polish: " F; code_polisher "$F"; read -p "Enter..."; show_dashboard ;;
        8) template_architect; read -p "Enter..."; show_dashboard ;;
        9) neural_diagnose; read -p "Enter..."; show_dashboard ;;
        10) library_updater; read -p "Enter..."; show_dashboard ;;
        11) self_update; exit ;;
        0) exit 0 ;;
        *) show_dashboard ;;
    esac
}

# --- CORE LOGIC CORE ---

function execute_compiler() {
    local ENG=$1; local PROF=$2; shift 2; local FILE="${!#}"; local ARGS=(); [ $# -gt 1 ] && ARGS=("${@:1:$#-1}")
    [[ "$FILE" != *.pwn ]] && { echo -e "${RED}[Error]${NC} Invalid target."; return 1; }
    local FDIR="$(dirname "$FILE")"
    if [ "$PROF" = "auto" ]; then
        if [ -f "pawn.json" ] || [ -f "$FDIR/pawn.json" ] || [ -f "$FDIR/../pawn.json" ]; then PROF="omp"
        else PROF="legacy"; fi
    fi
    [ "$ENG" = "auto" ] && { [ "$PROF" = "omp" ] && ENG="qawno" || ENG="pawno"; }
    local OUT="/tmp/fpawn_out.log"; local INC_FLAGS=("-i$GLOBAL_INC")
    [ "$PROF" = "omp" ] && { INC_FLAGS+=("-iinclude" "-idependencies" "-i$FDIR/../include" "-i$CACHE_DIR"); }
    [ "$PROF" = "legacy" ] && { INC_FLAGS+=("-ipawno/include" "-iinclude" "-i$CACHE_DIR"); }
    
    if [ "$ENG" = "qawno" ]; then
        chmod +x "$QAWNO_DIR/pawncc"; export LD_LIBRARY_PATH="$QAWNO_DIR:$LD_LIBRARY_PATH"
        "$QAWNO_DIR/pawncc" "$FILE" "${ARGS[@]}" "${INC_FLAGS[@]}" "-i$QAWNO_DIR/include" "-;+" > "$OUT" 2>&1
    else
        wine "$PAWNO_DIR/pawncc.exe" "$FILE" "${ARGS[@]}" "${INC_FLAGS[@]}" "-i$PAWNO_DIR/include" > "$OUT" 2>&1
    fi
    cat "$OUT" | sed -u -e "s/error \([0-9]\{3\}\)/\x1b[1;31merror \1\x1b[0m/g" -e "s/warning \([0-9]\{3\}\)/\x1b[1;33mwarning \1\x1b[0m/g"
    return $?
}

function self_update() {
    local R="https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/fpawn"
    curl -L -s -o /tmp/fupd "$R"
    if [ $? -eq 0 ]; then
        local NV=$(grep "Version:" /tmp/fupd | head -n 1 | awk '{print $3}')
        if [ "$NV" != "17.0" ] && [ -n "$NV" ]; then
             echo -e "${YELLOW}[Alert]${NC} Master v$NV ready. Upgrading..."; cp /tmp/fupd "$BASE_DIR/fpawn"; chmod +x "$BASE_DIR/fpawn"; exit 0
        else echo -e "${GREEN}[Ready]${NC} System is fully evolved."; fi
    fi
}

function library_updater() {
    local TD="include"; [ -d "pawno/include" ] && TD="pawno/include"; mkdir -p "$TD" "$CACHE_DIR"
    echo -e "${BLUE}[Cache]${NC} Seeding Global Ecosystem..."
    
    # Download to Global Cache
    curl -L -s -o "$CACHE_DIR/open.mp.inc" "https://raw.githubusercontent.com/openmultiplayer/open.mp-stdlib/master/open.mp.inc"
    curl -L -s -o "$CACHE_DIR/a_samp.inc" "https://raw.githubusercontent.com/pawn-lang/samp-stdlib/master/a_samp.inc"
    
    # Copy to project
    cp "$CACHE_DIR/"*.inc "$TD/"
    echo -e "${GREEN}[Done]${NC} Project synchronized with Global Cache."
}

function dynamic_search() {
    local QUERY=$1; echo -e "${BLUE}[Neural]${NC} Accessing GitHub Vault..."
    local JSON=$(curl -s "https://api.github.com/search/repositories?q=${QUERY}+pawn+language:Pawn&sort=stars")
    RESULTS=$(echo "$JSON" | jq -r '.items[] | select(.html_url != null) | "\(.full_name)|\(.html_url)|\(.description)"' | head -n 5)
    if [ -n "$RESULTS" ]; then
        local i=1; local URLS=(); local NAMES=()
        IFS=$'\n'; for RES in $RESULTS; do
            URLS+=( "$(echo "$RES" | cut -d'|' -f2)" ); NAMES+=( "$(echo "$RES" | cut -d'|' -f1 | cut -d'/' -f2)" )
            echo -e " [i] [$i] ${BOLD}${CYAN}$(echo "$RES" | cut -d'|' -f1)${NC}"; ((i++))
        done; unset IFS
        read -p " Clone Index: " PICK
        [[ "$PICK" =~ ^[1-5]$ ]] && { git clone --depth 1 "${URLS[$PICK-1]}" "${NAMES[$PICK-1]}"; }
    fi
}

function smart_finder() {
    local INC=$1; local RESP=$(curl -s "https://api.github.com/search/code?q=filename:$INC+extension:inc")
    local URL=$(echo "$RESP" | grep -o "\"html_url\": \"[^\"]*\"" | head -n 1 | sed 's/"html_url": //;s/"//g;s/github.com/raw.githubusercontent.com/;s/\/blob\//\//')
    if [ -n "$URL" ]; then 
        mkdir -p "$CACHE_DIR"; curl -L -s -o "$CACHE_DIR/$INC" "$URL"
        [ -f "$CACHE_DIR/$INC" ] && ! head -n 1 "$CACHE_DIR/$INC" | grep -q "404:" && { cp "$CACHE_DIR/$INC" "include/"; return 0; }
    fi; return 1
}

function server_runner() {
    local B=""; [ -f "./omp-server" ] && B="./omp-server"; [ -f "./samp03svr" ] && B="./samp03svr"
    export LD_LIBRARY_PATH=".:$LD_LIBRARY_PATH"
    [ -n "$B" ] && "$B" 2>&1 | sed -u -e "s/error.*/${RED}&${NC}/i" -e "s/info.*/${GREEN}&${NC}/i"
}

# boot
load_config
if [ $# -eq 0 ]; then show_dashboard; exit 0; fi
while [[ $# -gt 0 ]]; do
    case $1 in
        --polish) code_polisher "$2"; exit 0 ;;
        --init) template_architect; exit 0 ;;
        --diagnose) neural_diagnose; exit 0 ;;
        --search) dynamic_search "$2"; exit 0 ;;
        --scan) project_scanner; exit 0 ;;
        --refresh) library_updater; exit 0 ;;
        --update-self) self_update; exit 0 ;;
        *.pwn) PASSED_ARGS+=( "$1" ); shift ;;
        *) shift ;;
    esac
done
execute_compiler "auto" "auto" "${PASSED_ARGS[@]}"
