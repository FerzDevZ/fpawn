#!/bin/bash

# fpawn Master - The Ultimate Pawn Application
# Created for: FerzDevZ
# Version: 18.0 (Nebula Edition)
# Engines: qawno (open.mp) & pawno (Legacy SAMP)
# Repo: https://github.com/FerzDevZ/fpawn

# --- DIRECTORIES ---
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" 
done
BASE_DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"

QAWNO_DIR="$BASE_DIR/qawno"
PAWNO_DIR="$BASE_DIR/pawno"
GLOBAL_INC="$BASE_DIR/bin/includes"
CONFIG_FILE="$HOME/.ferzdevz/fpawn/config"
CACHE_DIR="$HOME/.ferzdevz/fpawn/cache/includes"

# Colors (Nebula Sapphire Palette)
GREEN='\033[38;5;82m'
BLUE='\033[38;5;39m'
RED='\033[38;5;196m'
YELLOW='\033[38;5;226m'
CYAN='\033[38;5;51m'
MAGENTA='\033[38;5;201m'
ORANGE='\033[38;5;208m'
WHITE='\033[38;5;255m'
LBLUE='\033[38;5;123m'
BOLD='\033[1m'
NC='\033[0m'

# --- CONFIGURATION & LOCALIZATION ---

function load_config() {
    REPO_OWNER="FerzDevZ"
    REPO_NAME="fpawn"
    mkdir -p "$(dirname "$CONFIG_FILE")" "$CACHE_DIR"
    [ ! -f "$CONFIG_FILE" ] && echo -e "REPO_OWNER=\"FerzDevZ\"\nREPO_NAME=\"fpawn\"\nLANG=\"id\"" > "$CONFIG_FILE"
    source "$CONFIG_FILE"
}

function set_lang() {
    local L=$1; grep -q "LANG=" "$CONFIG_FILE" && sed -i "s/LANG=.*/LANG=\"$L\"/" "$CONFIG_FILE" || echo "LANG=\"$L\"" >> "$CONFIG_FILE"
    echo -e "${GREEN}[Success]${NC} Language set to $L. Restarting session..."
    LANG=$L
}

# --- TEXT ENGINE ---
function msg() {
    local ID=$1
    if [ "$LANG" == "id" ]; then
        case $ID in
            welcome) echo "Selamat Datang di fpawn v18.0" ;;
            status) echo "Status Ekosistem" ;;
            menu_1) echo "Kompilasi Script" ;;
            menu_2) echo "Jalankan Instance" ;;
            menu_3) echo "Matrix Monitor" ;;
            menu_4) echo "Marketplace & Search" ;;
            menu_5) echo "Analisis Arsitektur" ;;
            menu_6) echo "Autopilot Scan" ;;
            menu_7) echo "Code Polisher (âœ¨)" ;;
            menu_8) echo "Architect Template (ðŸ—ï¸)" ;;
            menu_9) echo "Snippets Sandbox (ðŸ§ª)" ;;
            menu_10) echo "Sinkronisasi Library" ;;
            menu_11) echo "Cloud Self-Update" ;;
            menu_0) echo "Matikan Suite" ;;
            entry_err) echo "Entry point tidak ditemukan." ;;
            success) echo "Berhasil!" ;;
        esac
    else
        case $ID in
            welcome) echo "Welcome to fpawn v18.0" ;;
            status) echo "Ecosystem Status" ;;
            menu_1) echo "Compile Target" ;;
            menu_2) echo "Start Instance" ;;
            menu_3) echo "Matrix Monitor" ;;
            menu_4) echo "Marketplace & Search" ;;
            menu_5) echo "Arch Analyst" ;;
            menu_6) echo "Autopilot Scan" ;;
            menu_7) echo "Code Polisher (âœ¨)" ;;
            menu_8) echo "Architect Template (ðŸ—ï¸)" ;;
            menu_9) echo "Snippets Sandbox (ðŸ§ª)" ;;
            menu_10) echo "Library Sync" ;;
            menu_11) echo "Cloud Self-Update" ;;
            menu_0) echo "Shutdown Suite" ;;
            entry_err) echo "Entry point not detected." ;;
            success) echo "Success!" ;;
        esac
    fi
}

# --- SNIPPETS SANDBOX (ðŸ§ª) ---

function snippet_sandbox() {
    echo -e "${MAGENTA}[Sandbox]${NC} Initiating Isolated Lab Environment..."
    local WORK_DIR=$(mktemp -d -t fpawn_sandbox.XXXXXX)
    cd "$WORK_DIR"
    mkdir include
    cp -r "$GLOBAL_INC/"* include/ 2>/dev/null
    
    cat > sandbox.pwn <<EOF
#include <open.mp>

main() {
    print("----------------------------------");
    print(" fpawn NEBULA SANDBOX ONLINE      ");
    print(" Testing logic in isolation...    ");
    print("----------------------------------");
    
    // Write your test logic here
    
}
EOF
    echo -e "${BLUE}[Lab]${NC} Environment ready at ${CYAN}$WORK_DIR${NC}"
    echo -e "${YELLOW}[Action]${NC} Opening sandbox.pwn... (Exit to cleanup)"
    nano sandbox.pwn
    
    echo -e "${BLUE}[Compile]${NC} Testing sandbox synthesis..."
    execute_compiler "auto" "auto" "sandbox.pwn"
    
    rm -rf "$WORK_DIR"
    echo -e "${GREEN}[Cleanup]${NC} Lab environment de-materialized."
}

# --- GIT AUTO-PILOT (ðŸš) ---

function git_orchestrator() {
    local MSG=$1
    if [ -d ".git" ]; then
        git add .
        git commit -m "[fpawn v18.0] $MSG" &>/dev/null
        echo -e "${LBLUE}[Git]${NC} Auto-commit: $MSG"
    fi
}

# --- THE ARTISAN (CODE POLISHER) ---

function code_polisher() {
    local TARGET=$1
    [[ -z "$TARGET" ]] && TARGET=$(find_entry_point)
    [[ -z "$TARGET" ]] && { echo -e "${RED}[Error]${NC} $(msg entry_err)"; return 1; }

    echo -e "${CYAN}[Artisan]${NC} Polishing ${BOLD}$TARGET${NC} aesthetics..."
    local TEMP="/tmp/polisher_tmp.pwn"
    cat "$TARGET" | sed 's/^\s*//' | sed 's/\s*$//' | sed -E 's/([^ <>!=])=([^ =])/\1 = \2/g' | sed 's/{/ {\n/g' | sed 's/}/\n}\n/g' | \
    awk '{if ($0 ~ /}/) indent--; for (i=0; i<indent; i++) printf "    "; print $0; if ($0 ~ /{/) indent++;}' > "$TEMP"
    cp "$TEMP" "$TARGET"; rm -f "$TEMP"
    echo -e "${GREEN}[Success]${NC} $(msg success)"
    git_orchestrator "Polished code for $TARGET"
}

# --- THE ARCHITECT (MODULAR GM) ---

function template_architect() {
    echo -e "${BLUE}[Architect]${NC} Casting Modular Foundation..."
    local NAME="gm_modular"; read -p " Project Name: " PNAME
    [ -n "$PNAME" ] && NAME=$PNAME
    mkdir -p "$NAME/core" "$NAME/modules" "$NAME/src" "$NAME/include"
    cat > "$NAME/src/main.pwn" <<EOF
#include <open.mp>
main() { print("Modular Project: $NAME v18"); }
EOF
    echo -e "${GREEN}[Success]${NC} $(msg success)"
}

# --- ULTIMATE MARKETPLACE (ðŸ›ï¸) ---

function marketplace_hub() {
    local CAT=("Utility" "Gameplay" "Anti-Cheat" "Optimization")
    echo -e " ${LBLUE}ðŸŒŒ fpawn Marketplace - Featured Repositories${NC}"
    echo -e " [1] openmultiplayer/open.mp-stdlib"
    echo -e " [2] samp-incognito/samp-streamer-plugin"
    echo -e " [3] pBlueG/SA-MP-MySQL"
    echo -e " [4] Y-Less/sscanf"
    echo -e " [5] Search Custom Galaxy..."
    echo ""
    read -p " Select or Search: " MCHOICE
    case $MCHOICE in
        1) repo_cloner "https://github.com/openmultiplayer/open.mp-stdlib" "open.mp-stdlib" ;;
        2) repo_cloner "https://github.com/samp-incognito/samp-streamer-plugin" "streamer" ;;
        3) repo_cloner "https://github.com/pBlueG/SA-MP-MySQL" "mysql" ;;
        4) repo_cloner "https://github.com/Y-Less/sscanf" "sscanf" ;;
        5) read -p " Keywords: " S; dynamic_search "$S" ;;
        *) return ;;
    esac
}

# --- HELPERS & INTELLIGENCE ---

function find_entry_point() {
    [ -f "main.pwn" ] && { echo "main.pwn"; return; }
    [ -f "src/main.pwn" ] && { echo "src/main.pwn"; return; }
    [ -f "gamemodes/main.pwn" ] && { echo "gamemodes/main.pwn"; return; }
    local ANY=$(find . -maxdepth 2 -name "*.pwn" | head -n 1 | sed 's|^./||')
    echo "$ANY"
}

# --- TUI V5 NEBULA ---

function show_header() {
    clear
    echo -e " ${WHITE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e " ${WHITE}â•‘${NC}${BOLD}${CYAN}      fpawn v18.0 - FerzDevZ Nebula Edition               ${NC}${WHITE}â•‘${NC}"
    echo -e " ${WHITE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    local STATUS="${RED}DARK${NC}"
    [ -f "pawn.json" ] && STATUS="${GREEN}SYNCHRONIZED (OMP)${NC}"
    [ -f "server.cfg" ] && STATUS="${YELLOW}LEGACY (SAMP)${NC}"
    echo -e "  $(msg status): $STATUS"
    echo ""
}

function show_dashboard() {
    show_header
    echo -e "  ${BOLD}ENGINEERING${NC}                    ${BOLD}NEBULA CORE${NC}"
    echo -e "  [1] $(msg menu_1)             [4] $(msg menu_4)"
    echo -e "  [2] $(msg menu_2)             [5] $(msg menu_5)"
    echo -e "  [3] $(msg menu_3)             [6] $(msg menu_6)"
    echo ""
    echo -e "  ${BOLD}DEVELOPER LAB${NC}                  ${BOLD}SYSTEM${NC}"
    echo -e "  [7] $(msg menu_7)         [10] $(msg menu_10)"
    echo -e "  [8] $(msg menu_8)      [11] $(msg menu_11)"
    echo -e "  [9] $(msg menu_9)         [12] Language: ${LANG^^}"
    echo -e "  [0] $(msg menu_0)"
    echo ""
    echo -e " ${WHITE}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    read -p " Selection Master: " CHOICE
    case $CHOICE in
        1) local F=$(find_entry_point); execute_compiler "auto" "auto" "${F:-main.pwn}"; exit ;;
        2) server_runner; exit ;;
        3) local F=$(find_entry_point); run_watch_mode "${F:-main.pwn}"; exit ;;
        4) marketplace_hub; read -p "Done..."; show_dashboard ;;
        5) static_analyst; read -p "Done..."; show_dashboard ;;
        6) project_scanner; read -p "Done..."; show_dashboard ;;
        7) read -p " Target: " FT; code_polisher "$FT"; read -p "Done..."; show_dashboard ;;
        8) template_architect; read -p "Done..."; show_dashboard ;;
        9) snippet_sandbox; show_dashboard ;;
        10) library_updater; read -p "Done..."; show_dashboard ;;
        11) self_update; exit ;;
        12) [ "$LANG" == "id" ] && set_lang "en" || set_lang "id"; show_dashboard ;;
        0) exit 0 ;;
        *) show_dashboard ;;
    esac
}

# --- CORE LOGIC (VITAL) ---

function execute_compiler() {
    local ENG=$1; local PROF=$2; shift 2; local FILE="${!#}"; local ARGS=(); [ $# -gt 1 ] && ARGS=("${@:1:$#-1}")
    [[ "$FILE" != *.pwn ]] && { echo -e "${RED}[Error] $(msg entry_err)"; return 1; }
    local FDIR="$(dirname "$FILE")"
    if [ "$PROF" = "auto" ]; then
        if [ -f "pawn.json" ] || [ -f "$FDIR/pawn.json" ] || [ -f "$FDIR/../pawn.json" ]; then PROF="omp"
        else PROF="legacy"; fi
    fi
    [ "$ENG" = "auto" ] && { [ "$PROF" = "omp" ] && ENG="qawno" || ENG="pawno"; }
    local OUT="/tmp/fpawn_out.log"; local INC_FLAGS=("-i$GLOBAL_INC")
    [ "$PROF" = "omp" ] && { INC_FLAGS+=("-iinclude" "-idependencies" "-i$FDIR/../include" "-i$CACHE_DIR"); }
    [ "$PROF" = "legacy" ] && { INC_FLAGS+=("-ipawno/include" "-iinclude" "-i$CACHE_DIR"); }
    
    if [ "$ENG" = "qawno" ]; then
        chmod +x "$QAWNO_DIR/pawncc"; export LD_LIBRARY_PATH="$QAWNO_DIR:$LD_LIBRARY_PATH"
        "$QAWNO_DIR/pawncc" "$FILE" "${ARGS[@]}" "${INC_FLAGS[@]}" "-i$QAWNO_DIR/include" "-;+" > "$OUT" 2>&1
    else
        wine "$PAWNO_DIR/pawncc.exe" "$FILE" "${ARGS[@]}" "${INC_FLAGS[@]}" "-i$PAWNO_DIR/include" > "$OUT" 2>&1
    fi
    cat "$OUT" | sed -u -e "s/error \([0-9]\{3\}\)/\x1b[1;31merror \1\x1b[0m/g" -e "s/warning \([0-9]\{3\}\)/\x1b[1;33mwarning \1\x1b[0m/g"
    return $?
}

function repo_cloner() {
    local URL=$1; local NAME=$2; echo -e "${BLUE}[Cloner]${NC} Syncing $NAME..."; git clone --depth 1 "$URL" "$NAME"
    [ $? -eq 0 ] && { echo -e "${GREEN}[Success]${NC} $(msg success)"; git_orchestrator "Installed plugin $NAME"; } || echo -e "${RED}[Error]${NC} Failed."
}

function dynamic_search() {
    local QUERY=$1; echo -e "${BLUE}[Neural]${NC} Accessing GitHub Vault..."
    local JSON=$(curl -s "https://api.github.com/search/repositories?q=${QUERY}+pawn+language:Pawn&sort=stars")
    RESULTS=$(echo "$JSON" | jq -r '.items[] | select(.html_url != null) | "\(.full_name)|\(.html_url)|\(.description)"' | head -n 5)
    if [ -n "$RESULTS" ]; then
        local i=1; local URLS=(); local NAMES=()
        IFS=$'\n'; for RES in $RESULTS; do
            URLS+=( "$(echo "$RES" | cut -d'|' -f2)" ); NAMES+=( "$(echo "$RES" | cut -d'|' -f1 | cut -d'/' -f2)" )
            echo -e " [i] [$i] ${BOLD}${CYAN}$(echo "$RES" | cut -d'|' -f1)${NC} - $(echo "$RES" | cut -d'|' -f3)"; ((i++))
        done; unset IFS
        read -p " Clone Index [1-5]: " PICK
        [[ "$PICK" =~ ^[1-5]$ ]] && repo_cloner "${URLS[$PICK-1]}" "${NAMES[$PICK-1]}"
    fi
}

function self_update() {
    local R="https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/fpawn"
    curl -L -s -o /tmp/fupd "$R"; local NV=$(grep "Version:" /tmp/fupd | head -n 1 | awk '{print $3}')
    if [ "$NV" != "18.0" ] && [ -n "$NV" ]; then
         echo -e "${YELLOW}[Alert]${NC} Master v$NV ready. Upgrading..."; cp /tmp/fupd "$BASE_DIR/fpawn"; chmod +x "$BASE_DIR/fpawn"; exit 0
    else echo -e "${GREEN}[Ready]${NC} System is Nebula standard."; fi
}

function library_updater() {
    local TD="include"; [ -d "pawno/include" ] && TD="pawno/include"; mkdir -p "$TD" "$CACHE_DIR"
    echo -e "${BLUE}[Cache]${NC} Seeding Global Ecosystem..."
    curl -L -s -o "$CACHE_DIR/open.mp.inc" "https://raw.githubusercontent.com/openmultiplayer/open.mp-stdlib/master/open.mp.inc"
    curl -L -s -o "$CACHE_DIR/a_samp.inc" "https://raw.githubusercontent.com/pawn-lang/samp-stdlib/master/a_samp.inc"
    cp "$CACHE_DIR/"*.inc "$TD/"; echo -e "${GREEN}[Done]${NC} $(msg success)"
}

function server_runner() {
    local B=""; [ -f "./omp-server" ] && B="./omp-server"; [ -f "./samp03svr" ] && B="./samp03svr"
    export LD_LIBRARY_PATH=".:$LD_LIBRARY_PATH"; [ -n "$B" ] && "$B" 2>&1 | sed -u -e "s/error.*/${RED}&${NC}/i" -e "s/info.*/${GREEN}&${NC}/i"
}

# boot
load_config
if [ $# -eq 0 ]; then show_dashboard; exit 0; fi
while [[ $# -gt 0 ]]; do
    case $1 in
        --sandbox) snippet_sandbox; exit 0 ;;
        --lang) set_lang "$2"; exit 0 ;;
        --polish) code_polisher "$2"; exit 0 ;;
        --search) dynamic_search "$2"; exit 0 ;;
        --scan) project_scanner; exit 0 ;;
        --refresh) library_updater; exit 0 ;;
        --update-self) self_update; exit 0 ;;
        *.pwn) PASSED_ARGS+=( "$1" ); shift ;;
        *) shift ;;
    esac
done
execute_compiler "auto" "auto" "${PASSED_ARGS[@]}"
